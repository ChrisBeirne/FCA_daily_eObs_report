---
title: "Osa Conservation: Tracker Checker"

author:
  - Chris Beirne


site: bookdown::test-bookdown
output: bookdown::gitbook
documentclass: book
biblio-style: apalike
link-citations: yes
---

# Tracker status checker

This document summarize the movement locations for all active collars within Osa Conservation's `OC Vultures` project. 

```{r, echo=F, message=F, include=F}
library(move)
library(dplyr)
library(leaflet)
library(sf)
library(viridis)
library(kableExtra)
library(lubridate)
library(plotly)



# Import passcodes
#MOVE_PASS <- Sys.getenv("MOVEBANK_PASSWORD")
#MOVE_USE <- Sys.getenv("MOVEBANK_USERNAME")

loginStored <- movebankLogin(username=MOVE_USE, 
                             password=MOVE_PASS)

# Get animals
animals <-getMovebankAnimals(study=1573471517,login=loginStored)
# For some reason they are duplicated
animals[duplicated(animals)==F,]
# They vary by the field "sensor_type_id"
animals <- animals[animals$sensor_type_id==653,]

# Get last 2 weeks
t <- now("America/Costa_Rica")
start_t <- t-as.difftime(14,units='days')


dat <- getMovebankData(study=1573471517, login=loginStored,  removeDuplicatedTimestamps=TRUE,
                       timestamp_start=start_t)

# all data
dat <- getMovebankData(study=1573471517, login=loginStored,  removeDuplicatedTimestamps=TRUE)

# Convery move stack to dataframe
dat <- as.data.frame(dat)

# Convert dat to costa rica time
dat$timestamp <- with_tz(dat$timestamp, tzone = "America/Costa_Rica")
dat$tag_id

```

*Last data request: `r now(tzone = "America/Costa_Rica")`*

The project currently contains `r length(unique(dat$tag_id))` active tag deployments (defined as being active within the last 14 days). 

```{r, include=F}
# Add the location data


dat <- left_join(dat, animals[, c("tag_id", "animalName")])
# Sort the names out

dat$animalName <- sub('\\_.*', '', dat$animalName)
# Add in the taxonomic group
dat$animalName <- paste0(dat$animalName, "_", sub('\\ .*', '', dat$taxon_canonical_name))
animals$animalName <- paste0(sub('\\_.*', '', animals$animalName), "_", sub('\\ .*', '', animals$taxon_canonical_name))

# Add a country column
dat$country <- dat$location_lat<0
dat$country[dat$country==T] <- "peru"
dat$country[dat$country==F] <- "costa_rica"
#table(dat$country)



# Costa rica

# Convert to shapefiles
dat <- dat[order(dat$animalName),]


lfc <- do.call(st_sfc,
              lapply(split(dat, dat$animalName),
                     function(d){st_linestring(as.matrix(d[,c("location_long", "location_lat")]))}))
dat_shp <- st_sf(data.frame(animalName=levels(factor(dat[,"animalName"])), geom=lfc))

#
#plot(dat$location_long[dat$country=="costa_rica"], dat$location_lat[dat$country=="costa_rica"])
#plot(st_geometry(dat_shp), add=T)




sp_dat <- dat[,c("animalName",    "country", "taxon_canonical_name" )]
sp_dat <- sp_dat[duplicated(sp_dat)==F,]

# add back in the metadata
dat_shp  <- left_join(dat_shp,sp_dat)

```

**Time since last check-in**

```{r, echo=F, include=F}
# Last location and time since present
dat$diff_time <- round(as.numeric(difftime(t, dat$timestamp, units="hours")),1)

last_obs <- dat %>% group_by(animalName) %>% summarize(hours_since_fix=min(diff_time))


last_sum  <- dat %>% 
  group_by(animalName) %>%
  slice(which.max(timestamp))


tmp <- last_sum[, c("animalName","country", "timestamp", "diff_time")]
colnames(tmp)[colnames(tmp)=="diff_time"] <- "time_since_checkin_h"
colnames(tmp)[colnames(tmp)=="timestamp"] <- "last_timestamp"
check_in_summary <- tmp[order(tmp$country, tmp$time_since_checkin_h),]


```


```{r, echo=F, message=F, warning=F}
tmp_col <- check_in_summary$time_since_checkin_h
tmp_col[tmp_col<12]<- 12

check_in_summary %>%
  kbl() %>%
  kable_styling()  %>%
    column_spec(4, color = "white",
              background = spec_color(tmp_col, begin=0,end = 0.7, direction=-1,
                                      option="D", scale_from = c(12,120)))


### Add additional data shown later
check_in_summary$duration <- difftime(check_in_summary$last_timestamp, start_t, "days")

### Total locations Mean eobs battery power, eobs accuracy
tmp_sum <- dat %>% group_by(animalName) %>% summarise(total_obs=n(), mean_batt=mean(eobs_battery_voltage, na.rm=T), loc_accuracy=mean(eobs_horizontal_accuracy_estimate, na.rm=T))
#colnames(dat)

check_in_summary <- left_join(check_in_summary, tmp_sum)
check_in_summary$locs_per_day <- check_in_summary$total_obs/as.numeric(check_in_summary$duration)

```

**Animals not seen for >14 days**

```{r, echo=F}
tmp2 <- animals[!(animals$animalName %in% tmp$animalName),]
tmp2$days_since_check_in<- round(as.numeric(difftime(t, tmp2$timestamp_end, units="days")),1)
tmp2 <- tmp2[order(tmp2$days_since_check_in),]
row.names(tmp2) <- 1:nrow(tmp2)

tmp2[, c("animalName", "timestamp_end", "days_since_check_in")] %>%
  kbl() %>%
  kable_styling()

```

#### Last 24 hours

```{r, echo=F}
dat_day <- dat[substr(dat$timestamp,1,10) == substr(t,1,10),]
```

In the last 24 hours we have received `r nrow(dat_day)` observations from `r length(unique(dat_day$tag_id))` individuals.

```{r, echo=F}
# #colnames(check_in_summary)
# 
# xform <- list(categoryorder = "array",
#               categoryarray = c(check_in_summary$animalName))
# 
# cols<- c("#fc8d59", "#99d594")
# fig <- plot_ly(check_in_summary, x = ~animalName, y = ~locs_per_day, type = 'bar',
# 
#         marker = list(color = cols[as.factor(check_in_summary$country)]),
#         text=check_in_summary$country,
#         hoverinfo='text')
# 
# fig <- fig %>% layout(title = "Locations per day",
#                       xaxis = xform,
#                       xaxis = list(title = ""),
#                       yaxis = list(title = ""))
# 
# 
#  
# fig
```


#### 14-day summaries

Average number of locations per day (last 14 days):

```{r, echo=F}
#colnames(check_in_summary)

xform <- list(categoryorder = "array",
              categoryarray = c(check_in_summary$animalName))

cols<- c("#fc8d59", "#99d594")
fig <- plot_ly(check_in_summary, x = ~animalName, y = ~locs_per_day, type = 'bar',

        marker = list(color = cols[as.factor(check_in_summary$country)]),
        text=check_in_summary$country,
        hoverinfo='text')

fig <- fig %>% layout(title = "Locations per day",
                      xaxis = xform,
                      xaxis = list(title = ""),
                      yaxis = list(title = ""))


 
fig
```

Average battery level (last 14 days):


```{r, echo=F, warning=FALSE}
fig <- plot_ly(check_in_summary, x = ~animalName, y = ~mean_batt, type = 'bar',

        marker = list(color = cols[as.factor(check_in_summary$country)]),
        text=check_in_summary$country,
        hoverinfo='text')

fig <- fig %>% layout(title = "Battery power",
                      xaxis = xform,
                      xaxis = list(title = ""),
                      yaxis = list(title = ""))



fig
```

Average horizontal location accuracy (last 14 days):

```{r, echo=F, warning=F}
fig <- plot_ly(check_in_summary, x = ~animalName, y = ~loc_accuracy, type = 'bar',

        marker = list(color = cols[as.factor(check_in_summary$country)]),
        text=check_in_summary$country,
        hoverinfo='text')

fig <- fig %>% layout(title = "Location accuracy (m)",
                      xaxis = xform,
                      xaxis = list(title = ""),
                      yaxis = list(title = ""))



fig
```


**Costa Rica**

```{r, echo=F}
tmp <- dat[dat$country=="costa_rica",]
tmp_shp <- dat_shp[dat_shp$country=="costa_rica",]


# First lets choose a category to colour
tmp[,"animalName"] <- factor(tmp[,"animalName"])
tmp_shp$animalName <- factor(tmp_shp$animalName)

col.cat <- turbo(length(levels(tmp[,"animalName"])))
# Add it to the dataframe
tmp$colours <- col.cat[tmp[,"animalName"]]
tmp_shp$colours <- col.cat[tmp_shp$animalName]

```

We currently have `r length(unique(tmp$animalName))` vultures transmitting data in Costa Rica:

```{r, echo=F}
m <- leaflet() %>%
  # Add a satellite image layer
  addProviderTiles(providers$Stamen.TonerLite, group="Simple") %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%
  addProviderTiles(providers$Esri.WorldTopoMap, group="OS") %>%     
  addCircleMarkers(lng=tmp$location_long, lat=tmp$location_lat,
                   # Colour the markers depending on the 'feature type'
                   color=tmp$colours,
                   radius=3,
                   stroke=F,
                   # Add a popup of the deployment code 
                   popup=paste(tmp$animalName, tmp$timestamp)) %>%
  addPolylines(data=tmp_shp, color = tmp_shp$colours, weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5) %>% 
  # Add a legend explaining what is going on
  addLegend("bottomright", colors = col.cat,  labels = levels(tmp[,"animalName"]),
            title = "Name",
            labFormat = labelFormat(prefix = "$"),
            opacity = 1
  ) %>%
  # add a layer control box to toggle between the layers
  addLayersControl(
    baseGroups = c("Simple", "Satellite", "OS"),
    options = layersControlOptions(collapsed = FALSE)
  )
m
```

*Location activity over the last 14 days*

The plot below shows a point each time we have a location at a given time.

```{r, echo=F}
library(plotly)
yform <- list(categoryorder = "array",
              categoryarray = unique(tmp$animalName))


fig <- plot_ly(x = tmp$timestamp, y = tmp$animalName,type="scatter",
               height=1000, text=tmp$animalName, hoverinfo='text',
               mode   = 'markers',
               marker = list(size = 5,
                             color = 'rgba(50, 100, 255, .2)',
                             line = list(color = 'rgba(0, 0, 0, 0)',
                                         width = 0))) %>% 
              layout(yaxis = yform)
fig

```

**Daily schedule**

```{r, echo=F, warning=F, message=F}

tmp$hour <- as.numeric(substr(tmp$timestamp,12,13))
tmp$hour <- factor(tmp$hour, levels=0:23)
tmp$animalName <- as.factor(tmp$animalName)
tmp2 <- tmp %>% group_by(animalName, hour, .drop=F) %>% summarize(obs=n())


fig <- plot_ly(tmp2, x = ~hour, y = ~obs, name = tmp2$animalName, type = 'scatter', mode = 'lines',split = ~animalName) 
fig <- fig %>%  layout(title = "Hourly locations",
                      xaxis = xform,
                      xaxis = list(title = ""),
                      yaxis = list(title = "Number of locations"))

fig

```



**Peru**

```{r, echo=F}
tmp <- dat[dat$country=="peru",]
tmp_shp <- dat_shp[dat_shp$country=="peru",]


# First lets choose a category to colour
tmp[,"animalName"] <- factor(tmp[,"animalName"])
tmp_shp$animalName <- factor(tmp_shp$animalName)

col.cat <- turbo(length(levels(tmp[,"animalName"])))
# Add it to the dataframe
tmp$colours <- col.cat[tmp[,"animalName"]]
tmp_shp$colours <- col.cat[tmp_shp$animalName]

```


We currently have `r length(unique(tmp$animalName))` vultures transmitting data in Peru:


```{r, echo=F}
m <- leaflet() %>%
  # Add a satellite image layer
  addProviderTiles(providers$Stamen.TonerLite, group="Simple") %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%
  addProviderTiles(providers$Esri.WorldTopoMap, group="OS") %>%     
  addCircleMarkers(lng=tmp$location_long, lat=tmp$location_lat,
                   # Colour the markers depending on the 'feature type'
                   color=tmp$colours,
                   radius=3,
                   stroke=F,
                   # Add a popup of the deployment code 
                   popup=paste(tmp$animalName, tmp$timestamp)) %>%
  addPolylines(data=tmp_shp, color = tmp_shp$colours, weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5) %>% 
  # Add a legend explaining what is going on
  addLegend("bottomright", colors = col.cat,  labels = levels(tmp[,"animalName"]),
            title = "Name",
            labFormat = labelFormat(prefix = "$"),
            opacity = 1
  ) %>%
  # add a layer control box to toggle between the layers
  addLayersControl(
    baseGroups = c("Simple", "Satellite", "OS"),
    options = layersControlOptions(collapsed = FALSE)
  )
m
```


*Location activity over the last 14 days*

The plot below shows a point each time we have a location at a given time.

```{r, echo=F}
library(plotly)
yform <- list(categoryorder = "array",
              categoryarray = unique(tmp$animalName))


fig <- plot_ly(x = tmp$timestamp, y = tmp$animalName,type="scatter",
               height=1000, text=tmp$animalName, hoverinfo='text',
               mode   = 'markers',
               marker = list(size = 5,
                             color = 'rgba(50, 100, 255, .2)',
                             line = list(color = 'rgba(0, 0, 0, 0)',
                                         width = 0))) %>% 
              layout(yaxis = yform)
fig

```

**Daily schedule**

```{r, echo=F, warning=F, message=F}

tmp$hour <- as.numeric(substr(tmp$timestamp,12,13))
tmp$hour <- factor(tmp$hour, levels=0:23)

tmp$animalName <- as.factor(tmp$animalName)

tmp2 <- tmp %>% group_by(animalName, hour, .drop=F) %>% summarize(obs=n())


fig <- plot_ly(tmp2, x = ~hour, y = ~obs, name = tmp2$animalName, type = 'scatter', mode = 'lines',split = ~animalName) 
fig <- fig %>%  layout(title = "Hourly locations",
                      xaxis = xform,
                      xaxis = list(title = ""),
                      yaxis = list(title = "Number of locations"))

fig

```

# Last 48 Hours

The following maps relate to just the last 48 hours of data. Use this to find clusters and locations. 



